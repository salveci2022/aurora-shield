<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aurora Mulher Segura</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            min-height: 100vh;
            font-family: 'Segoe UI', Arial, sans-serif;
            color: #ffffff;
            padding: 15px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: #111111;
            border-radius: 30px;
            overflow: hidden;
            border: 1px solid #333333;
        }

        /* ========== TOP BAR ========== */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #000000;
            border-bottom: 1px solid #333333;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: #8a2be2;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .logo-text {
            font-size: 16px;
            font-weight: bold;
            color: #ff69b4;
            line-height: 1.2;
        }

        .logo-text small {
            display: block;
            font-size: 10px;
            color: #888888;
            font-weight: normal;
        }

        .action-buttons-top {
            display: flex;
            gap: 8px;
        }

        .top-btn {
            background: #222222;
            border: none;
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #444444;
        }

        .top-btn:hover {
            background: #333333;
        }

        .top-btn.sair {
            background: #8b0000;
            border-color: #ff0000;
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            padding: 20px;
        }

        /* ========== TITLE SECTION ========== */
        .title-section {
            margin-bottom: 25px;
        }

        .main-title {
            font-size: 28px;
            font-weight: bold;
            color: #ff69b4;
            margin-bottom: 5px;
        }

        .sub-title {
            font-size: 14px;
            color: #888888;
            border-left: 3px solid #8a2be2;
            padding-left: 10px;
        }

        /* ========== CARD ========== */
        .card {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333333;
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            color: #ff69b4;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ========== CONTATOS LADO A LADO ========== */
        .contatos-container {
            margin-bottom: 20px;
        }

        .contato-label {
            font-size: 14px;
            color: #888888;
            margin-bottom: 10px;
        }

        .contatos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .contato-card {
            background: #222222;
            border-radius: 10px;
            padding: 12px;
            border-left: 4px solid #ff69b4;
            text-align: center;
        }

        .contato-card .nome {
            font-weight: bold;
            color: #ff69b4;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .contato-card .telefone {
            font-size: 12px;
            color: #cccccc;
        }

        .contato-card .parentesco {
            font-size: 11px;
            color: #888888;
            margin-top: 4px;
        }

        /* ========== FORM ========== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            color: #888888;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            background: #222222;
            border: 1px solid #444444;
            border-radius: 10px;
            color: white;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: #8a2be2;
        }

        /* ========== TAGS ========== */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .tag {
            padding: 8px 16px;
            background: #222222;
            border: 1px solid #444444;
            border-radius: 20px;
            color: #cccccc;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
        }

        .tag:hover {
            background: #333333;
        }

        .tag.active {
            background: #8a2be2;
            border-color: #ff69b4;
            color: white;
        }

        /* ========== CHECKBOX ========== */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: #222222;
            border-radius: 10px;
        }

        .checkbox-wrapper input {
            width: 18px;
            height: 18px;
            accent-color: #ff69b4;
        }

        .checkbox-wrapper label {
            color: #cccccc;
            font-size: 14px;
        }

        .checkbox-wrapper small {
            color: #888888;
            font-size: 12px;
            margin-left: auto;
        }

        /* ========== SOS BUTTON ========== */
        .sos-wrapper {
            text-align: center;
            margin: 30px 0;
        }

        .sos-button {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff0000, #8b0000);
            border: 4px solid #ff69b4;
            color: white;
            font-size: 48px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            animation: pulse 2s infinite;
            transition: transform 0.1s;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 50px rgba(255, 0, 0, 0.5);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 80px rgba(255, 0, 0, 0.8);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 50px rgba(255, 0, 0, 0.5);
            }
        }

        .sos-subtitle {
            font-size: 16px;
            font-weight: normal;
            margin-top: 10px;
        }

        /* ========== BOTTOM NAV ========== */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #000000;
            padding: 15px;
            border-top: 1px solid #333333;
            margin-top: 20px;
        }

        .nav-item {
            text-align: center;
            color: #888888;
            font-size: 14px;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .nav-item:hover {
            color: #ff69b4;
            background: #1a1a1a;
        }

        .nav-item.active {
            color: #ff69b4;
            font-weight: bold;
        }

        .nav-item span {
            display: block;
            font-size: 20px;
            margin-bottom: 5px;
        }

        /* ========== STATUS MESSAGE ========== */
        .status-message {
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            text-align: center;
        }

        .status-message.success {
            background: #1a4d1a;
            border: 1px solid #00ff00;
            color: #aaffaa;
            display: block;
        }

        .status-message.error {
            background: #4d1a1a;
            border: 1px solid #ff0000;
            color: #ffaaaa;
            display: block;
        }

        .status-message.info {
            background: #1a1a4d;
            border: 1px solid #8a2be2;
            color: #aaaaff;
            display: block;
        }

        .status-message.warning {
            background: #4d4d1a;
            border: 1px solid #ffff00;
            color: #ffffaa;
            display: block;
        }

        /* ========== MODAL ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #8a2be2;
        }

        .modal-title {
            color: #ff69b4;
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ========== LISTA DE CONTATOS NO MODAL ========== */
        .contato-item {
            background: #222222;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid #ff69b4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contato-info h4 {
            color: #ff69b4;
            margin-bottom: 5px;
        }

        .contato-info p {
            color: #888888;
            font-size: 13px;
            margin: 2px 0;
        }

        .contato-acoes {
            display: flex;
            gap: 8px;
        }

        .btn-editar, .btn-excluir {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .btn-editar {
            background: #4a4a4a;
            color: white;
        }

        .btn-editar:hover {
            background: #666666;
        }

        .btn-excluir {
            background: #8b0000;
            color: white;
        }

        .btn-excluir:hover {
            background: #a00000;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .modal-btn.save {
            background: #8a2be2;
            color: white;
        }

        .modal-btn.cancel {
            background: #333333;
            color: white;
        }

        .modal-btn.danger {
            background: #8b0000;
            color: white;
        }

        /* ========== CONFIRMA√á√ÉO ========== */
        .confirm-box {
            background: #222222;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
        }

        .confirm-box p {
            margin-bottom: 20px;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="logo-area">
                <div class="logo-icon">üõ°Ô∏è</div>
                <div class="logo-text">
                    AURORA MULHER SEGURA
                    <small>Spy Life - Prote√ß√£o Feminina 24h</small>
                </div>
            </div>
            <div class="action-buttons-top">
                <button class="top-btn" onclick="reiniciar()">Reiniciar</button>
                <button class="top-btn" onclick="limpar()">Limpar</button>
                <button class="top-btn sair" onclick="sair()">Sair</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- TITLE SECTION -->
            <div class="title-section">
                <h1 class="main-title">BOT√ÉO DE P√ÇNICO</h1>
                <div class="sub-title">Vers√£o demonstrativa ‚Äî treino e fluxo de emerg√™ncia.</div>
            </div>

            <!-- STATUS MESSAGE -->
            <div id="statusMessage" class="status-message"></div>

            <!-- CARD PRINCIPAL -->
            <div class="card">
                <!-- PESSOAS DE CONFIAN√áA - LADO A LADO -->
                <div class="contatos-container">
                    <div class="contato-label">Pessoas de confian√ßa cadastradas:</div>
                    <div class="contatos-grid" id="contatosGrid">
                        <!-- Contatos ser√£o inseridos aqui via JavaScript -->
                    </div>
                </div>

                <!-- FORMUL√ÅRIO -->
                <div class="form-group">
                    <label class="form-label">Seu nome</label>
                    <input type="text" id="nome" class="form-input" value="SALVECI">
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo de situa√ß√£o:</label>
                    <div class="tags-container" id="situationTags">
                        <div class="tag active" data-situacao="Viol√™ncia f√≠sica">üî¥ Viol√™ncia f√≠sica</div>
                        <div class="tag" data-situacao="Agress√£o verbal">üó£Ô∏è Agress√£o verbal</div>
                        <div class="tag" data-situacao="Persegui√ß√£o">üëÅÔ∏è Persegui√ß√£o</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Situa√ß√£o de risco:</label>
                    <label class="form-label" style="font-size: 12px; color: #666;">Mensagem (opcional)</label>
                    <textarea id="mensagem" class="form-input" rows="2" placeholder="Descreva rapidamente o que est√° acontecendo (opcional)"></textarea>
                </div>

                <div class="checkbox-wrapper">
                    <input type="checkbox" id="shareLocation" checked>
                    <label for="shareLocation">‚úî Compartilhar localiza√ß√£o exata (GPS)</label>
                    <small>‚Äî ser√° pedida permiss√£o</small>
                </div>

                <div style="color: #888888; font-size: 13px; margin: 10px 0; text-align: center;">
                    Pronto. Toque e segure no SOS para enviar.
                </div>

                <!-- BOT√ÉO SOS -->
                <div class="sos-wrapper">
                    <button class="sos-button" id="sosBtn" onmousedown="startPress()" onmouseup="cancelPress()" onmouseleave="cancelPress()" ontouchstart="startPress()" ontouchend="cancelPress()">
                        SOS
                        <span class="sos-subtitle">TOQUE E SEGURE</span>
                    </button>
                </div>
            </div>

            <!-- BOTTOM NAVIGATION -->
            <div class="bottom-nav">
                <div class="nav-item active">
                    <span>üÜò</span>
                    SOS
                </div>
                <div class="nav-item" onclick="mostrarGerenciarContatos()">
                    <span>üë•</span>
                    Gerenciar Contatos
                </div>
                <div class="nav-item" onclick="mostrarAdmin()">
                    <span>‚öôÔ∏è</span>
                    Admin
                </div>
                <div class="nav-item" onclick="mostrarHistorico()">
                    <span>üìä</span>
                    Hist√≥rico
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL GERENCIAR CONTATOS -->
    <div class="modal" id="modalGerenciarContatos">
        <div class="modal-content">
            <h3 class="modal-title">üë• GERENCIAR CONTATOS</h3>
            <div id="listaContatosGerenciar" style="margin-bottom: 20px;">
                <!-- Contatos ser√£o inseridos aqui -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn save" onclick="mostrarModalAdicionar()">‚ûï ADICIONAR NOVO</button>
                <button class="modal-btn cancel" onclick="fecharModal('modalGerenciarContatos')">FECHAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL ADICIONAR CONTATO -->
    <div class="modal" id="modalAdicionarContato">
        <div class="modal-content">
            <h3 class="modal-title">‚ûï ADICIONAR CONTATO</h3>
            <div class="form-group">
                <label class="form-label">Nome</label>
                <input type="text" id="novoNome" class="form-input" placeholder="Nome completo">
            </div>
            <div class="form-group">
                <label class="form-label">Telefone</label>
                <input type="text" id="novoTelefone" class="form-input" placeholder="(11) 99999-9999">
            </div>
            <div class="form-group">
                <label class="form-label">Parentesco</label>
                <input type="text" id="novoParentesco" class="form-input" placeholder="Ex: M√£e, Irm√£, Amiga">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn save" onclick="salvarNovoContato()">SALVAR</button>
                <button class="modal-btn cancel" onclick="fecharModal('modalAdicionarContato')">CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR CONTATO -->
    <div class="modal" id="modalEditarContato">
        <div class="modal-content">
            <h3 class="modal-title">‚úèÔ∏è EDITAR CONTATO</h3>
            <input type="hidden" id="editandoIndex">
            <div class="form-group">
                <label class="form-label">Nome</label>
                <input type="text" id="editNome" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Telefone</label>
                <input type="text" id="editTelefone" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Parentesco</label>
                <input type="text" id="editParentesco" class="form-input">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn save" onclick="salvarEdicao()">SALVAR</button>
                <button class="modal-btn cancel" onclick="fecharModal('modalEditarContato')">CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIRMAR EXCLUS√ÉO -->
    <div class="modal" id="modalConfirmarExclusao">
        <div class="modal-content">
            <h3 class="modal-title">‚ö†Ô∏è CONFIRMAR EXCLUS√ÉO</h3>
            <div class="confirm-box">
                <p>Tem certeza que deseja excluir <span id="excluirNome"></span>?</p>
                <div class="modal-buttons">
                    <button class="modal-btn danger" onclick="confirmarExclusao()">SIM, EXCLUIR</button>
                    <button class="modal-btn cancel" onclick="fecharModal('modalConfirmarExclusao')">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ADMIN -->
    <div class="modal" id="modalAdmin">
        <div class="modal-content">
            <h3 class="modal-title">‚öôÔ∏è ADMIN</h3>
            <p style="color: #888; margin-bottom: 15px;">Configura√ß√µes do sistema</p>
            <div style="margin-bottom: 15px;">
                <label style="color: #ff69b4; display: block; margin-bottom: 5px;">Tempo de pressionar SOS</label>
                <input type="range" id="tempoSOS" min="1" max="5" value="2" step="0.5" style="width: 100%;">
                <small style="color: #888;"><span id="tempoDisplay">2</span> segundos</small>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn save" onclick="salvarConfig()">SALVAR</button>
                <button class="modal-btn cancel" onclick="fecharModal('modalAdmin')">FECHAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL HIST√ìRICO -->
    <div class="modal" id="modalHistorico">
        <div class="modal-content">
            <h3 class="modal-title">üìä HIST√ìRICO DE ALERTAS</h3>
            <div id="listaAlertas" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Alertas ser√£o inseridos aqui -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn save" onclick="gerarPDF()">üì• PDF</button>
                <button class="modal-btn cancel" onclick="fecharModal('modalHistorico')">FECHAR</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // ============================================
        // VARI√ÅVEIS GLOBAIS
        // ============================================
        let pressTimer = null;
        let isPressing = false;
        let tempoPressionar = 2; // segundos
        
        // Contatos iniciais
        let contatos = [
            { nome: "CLECI", telefone: "(11) 99999-9999", parentesco: "M√£e" },
            { nome: "MARIA", telefone: "(11) 98888-8888", parentesco: "Irm√£" },
            { nome: "JO√ÉO", telefone: "(11) 97777-7777", parentesco: "Marido" }
        ];
        
        let alertas = [];
        let contatoParaExcluir = null;

        // ============================================
        // CARREGAR CONTATOS DO LOCALSTORAGE
        // ============================================
        function carregarContatos() {
            const contatosSalvos = localStorage.getItem('aurora_contatos');
            if (contatosSalvos) {
                contatos = JSON.parse(contatosSalvos);
            } else {
                localStorage.setItem('aurora_contatos', JSON.stringify(contatos));
            }
            atualizarGridContatos();
        }

        // ============================================
        // ATUALIZAR GRID DE CONTATOS (PAINEL PRINCIPAL)
        // ============================================
        function atualizarGridContatos() {
            const grid = document.getElementById('contatosGrid');
            
            if (contatos && contatos.length > 0) {
                let html = '';
                contatos.forEach(contato => {
                    html += `
                        <div class="contato-card">
                            <div class="nome">${contato.nome}</div>
                            <div class="telefone">${contato.telefone}</div>
                            <div class="parentesco">${contato.parentesco}</div>
                        </div>
                    `;
                });
                grid.innerHTML = html;
            } else {
                grid.innerHTML = '<div class="contato-card">Nenhum contato cadastrado</div>';
            }
        }

        // ============================================
        // FUN√á√ÉO PARA OBTER LOCALIZA√á√ÉO REAL
        // ============================================
        function obterLocalizacao() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject('Geolocaliza√ß√£o n√£o suportada pelo navegador');
                    return;
                }
                
                showStatus('üìç Solicitando permiss√£o de localiza√ß√£o...', 'info');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        console.log('üìç Localiza√ß√£o obtida:', coords);
                        resolve(coords);
                    },
                    (error) => {
                        let mensagemErro = 'Erro ao obter localiza√ß√£o: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                mensagemErro += 'Permiss√£o negada. Clique em "Permitir" nas configura√ß√µes do navegador.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                mensagemErro += 'Localiza√ß√£o indispon√≠vel.';
                                break;
                            case error.TIMEOUT:
                                mensagemErro += 'Tempo esgotado. Tente novamente.';
                                break;
                            default:
                                mensagemErro += error.message;
                        }
                        reject(mensagemErro);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // ============================================
        // FUN√á√ïES DO BOT√ÉO SOS
        // ============================================
        function startPress() {
            if (isPressing) return;
            isPressing = true;
            
            const btn = document.getElementById('sosBtn');
            btn.style.transform = 'scale(0.95)';
            btn.style.animation = 'none';
            
            pressTimer = setTimeout(() => {
                if (isPressing) {
                    enviarAlerta();
                }
            }, tempoPressionar * 1000);
        }

        function cancelPress() {
            isPressing = false;
            clearTimeout(pressTimer);
            
            const btn = document.getElementById('sosBtn');
            btn.style.transform = '';
            btn.style.animation = 'pulse 2s infinite';
        }

        // ============================================
        // ENVIAR ALERTA COM LOCALIZA√á√ÉO REAL
        // ============================================
        async function enviarAlerta() {
            const btn = document.getElementById('sosBtn');
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = 'ENVIANDO...';
            btn.disabled = true;
            
            const nome = document.getElementById('nome').value;
            const situacao = document.querySelector('.tag.active')?.getAttribute('data-situacao') || 'Emerg√™ncia';
            const mensagem = document.getElementById('mensagem').value;
            const shareLocation = document.getElementById('shareLocation').checked;
            
            showStatus('üö® Preparando alerta...', 'info');
            
            let lat = null;
            let lng = null;
            let localizacaoObtida = false;
            
            // Obter localiza√ß√£o se marcado
            if (shareLocation) {
                try {
                    showStatus('üìç Obtendo localiza√ß√£o...', 'info');
                    const pos = await obterLocalizacao();
                    lat = pos.lat;
                    lng = pos.lng;
                    localizacaoObtida = true;
                    showStatus('‚úÖ Localiza√ß√£o obtida com sucesso!', 'success');
                } catch (error) {
                    console.error('Erro GPS:', error);
                    showStatus('‚ö†Ô∏è ' + error, 'warning');
                }
            }
            
            // Criar objeto do alerta
            const alerta = {
                id: Date.now(),
                name: nome || 'An√¥nimo',
                situation: situacao,
                message: mensagem || 'Alerta de emerg√™ncia',
                lat: lat,
                lng: lng,
                date: new Date().toISOString()
            };
            
            // Salvar no hist√≥rico local
            alertas.unshift({
                data: new Date().toLocaleString(),
                situacao: situacao,
                localizacao: localizacaoObtida
            });
            
            // Enviar para o servidor (simula√ß√£o com localStorage)
            try {
                // Recuperar alertas existentes
                const alertasExistentes = JSON.parse(localStorage.getItem('aurora_alertas') || '[]');
                alertasExistentes.unshift(alerta);
                localStorage.setItem('aurora_alertas', JSON.stringify(alertasExistentes));
                
                // Mostrar mensagem de sucesso
                if (contatos.length > 0) {
                    const nomesContatos = contatos.map(c => c.nome).join(', ');
                    showStatus(`‚úÖ ALERTA ENVIADO para: ${nomesContatos}`, 'success');
                    
                    // Log detalhado
                    console.log('üö® ALERTA ENVIADO:');
                    console.log('Nome:', nome);
                    console.log('Situa√ß√£o:', situacao);
                    console.log('Mensagem:', mensagem);
                    console.log('Localiza√ß√£o:', localizacaoObtida ? `Lat: ${lat}, Lng: ${lng}` : 'N√£o compartilhada');
                    console.log('Contatos notificados:', contatos);
                    
                    // Vibrar se suportado
                    if (navigator.vibrate) {
                        navigator.vibrate([500, 200, 500]);
                    }
                } else {
                    showStatus('‚úÖ ALERTA ENVIADO (sem contatos cadastrados)', 'success');
                }
                
            } catch (error) {
                console.error('Erro ao salvar alerta:', error);
                showStatus('‚ùå Erro ao enviar alerta', 'error');
            }
            
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }

        // ============================================
        // FUN√á√ïES DAS TAGS
        // ============================================
        function selectTag(element) {
            document.querySelectorAll('.tag').forEach(tag => tag.classList.remove('active'));
            element.classList.add('active');
        }

        // ============================================
        // FUN√á√ïES DOS BOT√ïES SUPERIORES
        // ============================================
        function reiniciar() {
            document.getElementById('nome').value = 'SALVECI';
            document.getElementById('mensagem').value = '';
            document.getElementById('shareLocation').checked = true;
            
            document.querySelectorAll('.tag').forEach(tag => tag.classList.remove('active'));
            document.querySelector('.tag').classList.add('active');
            
            showStatus('Sistema reiniciado', 'success');
        }

        function limpar() {
            document.getElementById('mensagem').value = '';
            showStatus('Campos limpos', 'success');
        }

        function sair() {
            if (confirm('Deseja realmente sair?')) {
                window.location.href = '/';
            }
        }

        // ============================================
        // FUN√á√ïES DE NAVEGA√á√ÉO
        // ============================================
        function mostrarGerenciarContatos() {
            const modal = document.getElementById('modalGerenciarContatos');
            const lista = document.getElementById('listaContatosGerenciar');
            
            let html = '';
            contatos.forEach((contato, index) => {
                html += `
                    <div class="contato-item">
                        <div class="contato-info">
                            <h4>${contato.nome}</h4>
                            <p>üìû ${contato.telefone}</p>
                            <p>üë§ ${contato.parentesco}</p>
                        </div>
                        <div class="contato-acoes">
                            <button class="btn-editar" onclick="editarContato(${index})">‚úèÔ∏è Editar</button>
                            <button class="btn-excluir" onclick="confirmarExclusaoContato(${index})">üóëÔ∏è Excluir</button>
                        </div>
                    </div>
                `;
            });
            
            lista.innerHTML = html || '<p style="color: #888; text-align: center;">Nenhum contato cadastrado</p>';
            modal.style.display = 'flex';
        }

        function mostrarAdmin() {
            document.getElementById('modalAdmin').style.display = 'flex';
            document.getElementById('tempoDisplay').textContent = tempoPressionar;
            document.getElementById('tempoSOS').value = tempoPressionar;
        }

        function mostrarHistorico() {
            const modal = document.getElementById('modalHistorico');
            const lista = document.getElementById('listaAlertas');
            
            // Carregar alertas do localStorage
            const alertasSalvos = JSON.parse(localStorage.getItem('aurora_alertas') || '[]');
            
            let html = '';
            alertasSalvos.slice(0, 10).forEach(alerta => {
                const data = new Date(alerta.date).toLocaleString('pt-BR');
                html += `
                    <div style="background: #222; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #ff69b4;">${alerta.situation}</span>
                            <span style="color: #888; font-size: 12px;">${data}</span>
                        </div>
                        <div style="color: #666; font-size: 12px; margin-top: 5px;">
                            ${alerta.lat && alerta.lng ? 'üìç Localiza√ß√£o compartilhada' : 'üìç Sem localiza√ß√£o'}
                            ${alerta.lat ? `<br>üìå ${alerta.lat.toFixed(6)}, ${alerta.lng.toFixed(6)}` : ''}
                        </div>
                        <div style="color: #ff69b4; font-size: 11px; margin-top: 5px;">
                            üë§ ${alerta.name}
                        </div>
                    </div>
                `;
            });
            
            lista.innerHTML = html || '<p style="color: #888; text-align: center;">Nenhum alerta registrado</p>';
            modal.style.display = 'flex';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ============================================
        // FUN√á√ïES DE CONTATOS (CRUD COMPLETO)
        // ============================================
        
        function mostrarModalAdicionar() {
            fecharModal('modalGerenciarContatos');
            document.getElementById('modalAdicionarContato').style.display = 'flex';
        }

        function salvarNovoContato() {
            const nome = document.getElementById('novoNome').value.trim();
            const telefone = document.getElementById('novoTelefone').value.trim();
            const parentesco = document.getElementById('novoParentesco').value.trim();
            
            if (!nome || !telefone) {
                showStatus('Preencha nome e telefone!', 'error');
                return;
            }
            
            contatos.push({
                nome: nome,
                telefone: telefone,
                parentesco: parentesco || 'Contato'
            });
            
            localStorage.setItem('aurora_contatos', JSON.stringify(contatos));
            
            document.getElementById('novoNome').value = '';
            document.getElementById('novoTelefone').value = '';
            document.getElementById('novoParentesco').value = '';
            
            fecharModal('modalAdicionarContato');
            atualizarGridContatos();
            showStatus('‚úÖ Contato adicionado com sucesso!', 'success');
        }

        function editarContato(index) {
            const contato = contatos[index];
            
            document.getElementById('editandoIndex').value = index;
            document.getElementById('editNome').value = contato.nome;
            document.getElementById('editTelefone').value = contato.telefone;
            document.getElementById('editParentesco').value = contato.parentesco;
            
            fecharModal('modalGerenciarContatos');
            document.getElementById('modalEditarContato').style.display = 'flex';
        }

        function salvarEdicao() {
            const index = document.getElementById('editandoIndex').value;
            const nome = document.getElementById('editNome').value.trim();
            const telefone = document.getElementById('editTelefone').value.trim();
            const parentesco = document.getElementById('editParentesco').value.trim();
            
            if (!nome || !telefone) {
                showStatus('Preencha nome e telefone!', 'error');
                return;
            }
            
            contatos[index] = {
                nome: nome,
                telefone: telefone,
                parentesco: parentesco || 'Contato'
            };
            
            localStorage.setItem('aurora_contatos', JSON.stringify(contatos));
            
            fecharModal('modalEditarContato');
            atualizarGridContatos();
            showStatus('‚úÖ Contato editado com sucesso!', 'success');
        }

        function confirmarExclusaoContato(index) {
            contatoParaExcluir = index;
            document.getElementById('excluirNome').textContent = contatos[index].nome;
            fecharModal('modalGerenciarContatos');
            document.getElementById('modalConfirmarExclusao').style.display = 'flex';
        }

        function confirmarExclusao() {
            if (contatoParaExcluir !== null) {
                contatos.splice(contatoParaExcluir, 1);
                localStorage.setItem('aurora_contatos', JSON.stringify(contatos));
                contatoParaExcluir = null;
                fecharModal('modalConfirmarExclusao');
                atualizarGridContatos();
                showStatus('‚úÖ Contato exclu√≠do com sucesso!', 'success');
            }
        }

        // ============================================
        // CONFIGURA√á√ïES
        // ============================================
        document.getElementById('tempoSOS')?.addEventListener('input', function(e) {
            tempoPressionar = parseFloat(e.target.value);
            document.getElementById('tempoDisplay').textContent = tempoPressionar;
        });

        function salvarConfig() {
            showStatus(`‚è±Ô∏è Tempo alterado para ${tempoPressionar} segundos`, 'success');
            fecharModal('modalAdmin');
        }

        // ============================================
        // GERAR PDF
        // ============================================
        function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.setTextColor(255, 105, 180);
            doc.text('RELAT√ìRIO DE ALERTAS', 20, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Gerado em: ${new Date().toLocaleString()}`, 20, 30);
            
            const alertasSalvos = JSON.parse(localStorage.getItem('aurora_alertas') || '[]');
            
            let y = 40;
            alertasSalvos.slice(0, 10).forEach((alerta, index) => {
                const data = new Date(alerta.date).toLocaleString('pt-BR');
                
                doc.setFontSize(12);
                doc.setTextColor(255, 105, 180);
                doc.text(`${index + 1}. ${alerta.situation}`, 20, y);
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`Data: ${data}`, 25, y + 5);
                doc.text(`Localiza√ß√£o: ${alerta.lat && alerta.lng ? 'Compartilhada' : 'N√£o compartilhada'}`, 25, y + 10);
                doc.text(`Nome: ${alerta.name}`, 25, y + 15);
                
                y += 25;
            });
            
            doc.save('historico-alertas.pdf');
            showStatus('üì• PDF gerado com sucesso!', 'success');
            fecharModal('modalHistorico');
        }

        // ============================================
        // STATUS MESSAGE
        // ============================================
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + type;
            
            setTimeout(() => {
                statusDiv.className = 'status-message';
            }, 4000);
        }

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            carregarContatos();
            
            document.querySelectorAll('.tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    selectTag(this);
                });
            });
            
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            };
            
            // Verificar permiss√£o de localiza√ß√£o
            if (navigator.permissions) {
                navigator.permissions.query({ name: 'geolocation' }).then(result => {
                    if (result.state === 'denied') {
                        showStatus('‚ö†Ô∏è Permiss√£o de localiza√ß√£o negada. Ative nas configura√ß√µes do navegador.', 'warning');
                    }
                });
            }
        });
    </script>
</body>
</html>